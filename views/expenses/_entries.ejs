<%
const data = expense.data;
const participants = data.participants || [];
const entries = data.entries || [];
const currency = data.currency || 'â‚¬';

function calculateBalances() {
  const balances = {};
  participants.forEach(p => { balances[p.name] = 0; });
  
  entries.forEach(entry => {
    const splitCount = entry.split_between.length;
    if (splitCount === 0) return;
    
    const perPerson = entry.amount / splitCount;
    balances[entry.paid_by] += entry.amount;
    entry.split_between.forEach(name => {
      balances[name] -= perPerson;
    });
  });
  
  return balances;
}

function simplifyDebts(balances) {
  const creditors = [];
  const debtors = [];
  
  Object.entries(balances).forEach(([name, balance]) => {
    if (balance > 0.01) {
      creditors.push({ name, amount: balance });
    } else if (balance < -0.01) {
      debtors.push({ name, amount: -balance });
    }
  });
  
  creditors.sort((a, b) => b.amount - a.amount);
  debtors.sort((a, b) => b.amount - a.amount);
  
  const settlements = [];
  let i = 0, j = 0;
  
  while (i < debtors.length && j < creditors.length) {
    const debtor = debtors[i];
    const creditor = creditors[j];
    const amount = Math.min(debtor.amount, creditor.amount);
    
    if (amount > 0.01) {
      settlements.push({
        from: debtor.name,
        to: creditor.name,
        amount: amount.toFixed(2)
      });
    }
    
    debtor.amount -= amount;
    creditor.amount -= amount;
    
    if (debtor.amount < 0.01) i++;
    if (creditor.amount < 0.01) j++;
  }
  
  return settlements;
}

const balances = calculateBalances();
const settlements = simplifyDebts(balances);
%>
<h2>Expenses</h2>
<% if (entries.length === 0) { %>
  <p>No expenses recorded yet.</p>
<% } else { %>
  <div class="overflow-x-auto">
  <table class="expense-table">
    <thead>
      <tr>
        <th>Description</th>
        <th>Amount</th>
        <th>Paid By</th>
        <th>Split Between</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% for (let i = 0; i < entries.length; i++) { %>
        <tr>
          <td><%= entries[i].description %></td>
          <td><%= currency %><%= entries[i].amount.toFixed(2) %></td>
          <td><%= entries[i].paid_by %></td>
          <td><%= entries[i].split_between.join(', ') %></td>
          <td>
            <button 
              hx-delete="/e/<%= expense.id %>/entries/<%= i %>?token=<%= token %>" 
              hx-target="#expense-container" 
              hx-swap="innerHTML"
              hx-confirm="Delete this expense?"
              class="delete-btn"
            >Delete</button>
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
  </div>
<% } %>

<h2>Balances</h2>
<% if (settlements.length === 0) { %>
  <p>All settled up!</p>
<% } else { %>
  <ul class="settlements">
    <% settlements.forEach(s => { %>
      <li><strong><%= s.from %></strong> owes <strong><%= s.to %></strong> <%= currency %><%= s.amount %></li>
    <% }); %>
  </ul>
<% } %>

<h3>Add Expense</h3>
<form hx-post="/e/<%= expense.id %>/entries?token=<%= token %>" hx-target="#expense-container" hx-swap="innerHTML">
  <label for="description">Description</label>
  <input type="text" name="description" id="description" placeholder="e.g., Dinner" required>
  
  <label for="amount">Amount</label>
  <input type="number" name="amount" id="amount" step="0.01" min="0.01" placeholder="0.00" required>
  
  <p><strong>Paid by:</strong> <%= currentParticipant %></p>
  
  <label>Split between:</label>
  <div class="split-checkboxes">
    <% participants.forEach(p => { %>
      <label class="checkbox-label">
        <input type="checkbox" name="split[]" value="<%= p.name %>" checked>
        <%= p.name %>
      </label>
    <% }); %>
  </div>
  
  <button type="submit">Add Expense</button>
</form>

<p><a href="/e/<%= expense.id %>">View summary page</a></p>
<p><a href="/">Back to home</a></p>
