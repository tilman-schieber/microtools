<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/public/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F527;</text></svg>">
</head>
<body>
  <main>
    <h1>One-Time Secret</h1>
    <div id="secret-container">
      <p id="loading">Decrypting secret...</p>
      <div id="decrypted" style="display: none;">
        <pre id="secret-text" class="note-text"></pre>
        <p class="hint">This secret has been deleted from the server and cannot be viewed again.</p>
      </div>
      <div id="error" class="error" style="display: none;"></div>
    </div>
    <p><a href="/">Back to home</a></p>
  </main>

  <script>
    const ciphertext = <%= JSON.stringify(ciphertext) %>;

    async function importKey(keyStr) {
      let b64 = keyStr.replace(/-/g, '+').replace(/_/g, '/');
      while (b64.length % 4) b64 += '=';
      const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      return await crypto.subtle.importKey(
        'raw',
        raw,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );
    }

    async function decrypt(ciphertextB64, key) {
      let b64 = ciphertextB64.replace(/-/g, '+').replace(/_/g, '/');
      while (b64.length % 4) b64 += '=';
      const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));

      const iv = combined.slice(0, 12);
      const data = combined.slice(12);

      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );
      return new TextDecoder().decode(decrypted);
    }

    async function init() {
      const keyStr = location.hash.slice(1);
      const loadingEl = document.getElementById('loading');
      const decryptedEl = document.getElementById('decrypted');
      const secretTextEl = document.getElementById('secret-text');
      const errorEl = document.getElementById('error');

      if (!keyStr) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Missing decryption key in URL fragment.';
        return;
      }

      try {
        const key = await importKey(keyStr);
        const plaintext = await decrypt(ciphertext, key);

        loadingEl.style.display = 'none';
        decryptedEl.style.display = 'block';
        secretTextEl.textContent = plaintext;
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Decryption failed: ' + err.message;
      }
    }

    init();
  </script>
</body>
</html>
