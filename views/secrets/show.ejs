<% const content = `
  <main>
    <h1>One-Time Secret</h1>
    <div id="secret-container">
      <p id="loading">Decrypting secret...</p>
      <div id="decrypted" style="display: none;">
        <pre id="secret-text" class="note-text"></pre>
        <p class="hint">This secret has been deleted from the server and cannot be viewed again.</p>
      </div>
      <div id="error" style="display: none; color: red;"></div>
    </div>
    <p><a href="/">Back to home</a></p>
  </main>

  <script>
    const ciphertext = "${ciphertext}";

    // Import key from base64url
    async function importKey(keyStr) {
      // Restore base64 padding
      let b64 = keyStr.replace(/-/g, '+').replace(/_/g, '/');
      while (b64.length % 4) b64 += '=';
      const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      return await crypto.subtle.importKey(
        'raw',
        raw,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );
    }

    // Decrypt ciphertext with key
    async function decrypt(ciphertextB64, key) {
      // Restore base64 padding
      let b64 = ciphertextB64.replace(/-/g, '+').replace(/_/g, '/');
      while (b64.length % 4) b64 += '=';
      const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      
      const iv = combined.slice(0, 12);
      const data = combined.slice(12);
      
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );
      return new TextDecoder().decode(decrypted);
    }

    async function init() {
      const keyStr = location.hash.slice(1);
      const loadingEl = document.getElementById('loading');
      const decryptedEl = document.getElementById('decrypted');
      const secretTextEl = document.getElementById('secret-text');
      const errorEl = document.getElementById('error');

      if (!keyStr) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Missing decryption key in URL fragment.';
        return;
      }

      try {
        const key = await importKey(keyStr);
        const plaintext = await decrypt(ciphertext, key);
        
        loadingEl.style.display = 'none';
        decryptedEl.style.display = 'block';
        secretTextEl.textContent = plaintext;
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Decryption failed: ' + err.message;
      }
    }

    init();
  </script>
` %>
<%- include('../layout', { content, title }) %>
